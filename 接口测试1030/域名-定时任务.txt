*** Settings ***
Suite Teardown    Delete All Sessions
Library           requests
Library           json
Library           RequestsLibrary
Library           Collections
Library           demjson
Resource          ././PublicKW/CommentKW.txt
Resource          ././PublicRC/CommentRC.txt
Library           urllib2
Library           pic
Library           String
Library           Mytest01
Library           SmsService

*** Test Cases ***
星圈-集邮主题识别
    [Documentation]    2017-09-29 \ author：liqiong
    ...
    ...    说明：星圈、集邮、SDK开发者中的主题识别
    ...
    ...    1.星圈主题【情圣】md5=3b688962650ba44230ccac3f34defc3b_jpg
    ...    2.星圈主题【速度与激情8】md5=06fe189276e05b77d4595eaaec6fdc76_jpg
    ...    3.集邮主题【中秋月圆】md5=5692710732c211752fabfb6bb2267875_jpg
    ...    4.集邮主题【男子接力】md5=a5128d0f0820614652849238b48619c4_jpg
    [Tags]    test
    #检索、重叠、下载
    ${PictureName}    Set Variable    qingsheng.jpg    su8.jpg    zhongqiu.jpg    man.jpg    bicycle.jpg
    log    循环判断主题作品
    : FOR    ${index}    ${name}    IN ENUMERATE    @{PictureName}
    \    log    ${index}${name}
    \    SearchAR_YM    ${name}    ${URL}

离线包下载校验
    [Documentation]    2017-12-08 \ author：liqiong
    ...
    ...    说明：
    ...
    ...    1.登录获取cookies；
    ...    2.固定一个主题，获取下载离线包数据，通过离线包的单号issue，查询下载状态，判断process=1，说明下载成功。
    #登录获取cookies
    ${data}    Create Dictionary    editor_name=${username}    remember=1    editor_password=${PWD}
    ${header}    Create Dictionary    content-type=${Type}
    Create Session    VR    ${URL}    ${header}
    ${Resp}    Post Request    VR    /web/user/login    data=${data}    headers=${header}
    #校验接口返回状态的正确性
    Check_API_Response    ${Resp}
    #下载离线包数据
    ${rest}    Get Request    VR    /api/output/resource/re?ids=${YM_ids}&auth=123
    Should Be Equal As Strings    ${rest.status_code}    200
    ###从列表中获取字典的值
    ${list}    Get Json Value    ${rest.text}    /data/issue
    ${issue_num}    Load Json    ${list}
    #循环判断下载的离线包是否成功
    : FOR    ${index}    IN RANGE    120
    \    sleep    3s
    \    ${flag}    Set Variable    0
    \    ${rest}    Get Request    VR    /api/output/resource/state?issue=${issue_num}&auth=123
    \    Should Be Equal As Strings    ${rest.status_code}    200
    \    ###从列表中获取字典的值
    \    ${list}    Get Json Value    ${rest.text}    /data/process
    \    ${process_mesg}    Load Json    ${list}
    \    Run Keyword If    '${process_mesg}'=='1.0'    Exit For Loop
    \    ${flag}    Set Variable    1
    ####
    Run Keyword If    '${flag}'=='1'    fail    10min还没有下载完成，有异常，请排查！！！
    ...    ELSE    log    离线包数据下载成功~~~
    Delete All Sessions
    [Teardown]

AR效果显示
    [Documentation]    2017-12-12 \ author：liqiong
    ...
    ...    说明：
    ...
    ...    1.新生成一个作品，校验是否有AR星级效果展示；判断完成后删除作品；
    log    登录获取cookies
    #输入合理的值校验接口返回值正确性
    ${Resp}    Login_web    /web/user/login
    #校验接口返回状态的正确性
    Check_API_Response    ${Resp}
    log    编辑图片
    ${infilename}    Set Variable    INstartTest.jpg
    ${outPicNname}    Set Variable    OUTstartTest.jpg
    ##编辑图片，创建一个不同的md5
    ${in_file}    Evaluate    open(r'${Dir}\INstartTest.jpg','rb')
    Save Image    ${in_file}    ${Dir}${outPicNname}
    ##上传图片
    @{list}    ComuploadPic    ${outPicNname}
    ${MD5}    Get From List    ${list}    0
    log    ${MD5}
    ${fileID}    Get From List    ${list}    1
    log    ${fileID}
    log    创建之前先判断该作品是否存在，存在则删除。
    #校验上传的图片是否存在，存在则删除
    ${Resp_irsearch}    web_check_irsearch    ${MD5}    ${fileID}    ${URL}    /web/irsearch    ${Resp}
    #校验接口返回状态的正确性
    Check_API_Response    ${Resp_irsearch}
    #从列表中获取字典的值
    ${list}    Get Json Value    ${Resp_irsearch.text}    /data/resource_list
    ${resource_list}    Load Json    ${list}
    ${lengthList}    Get Length    ${resource_list}
    Run Keyword If    ${lengthList}!=0    Run Keyword    DeleteAR-BAK    ${Resp_irsearch.text}
    log    登录获取cookies
    #输入合理的值校验接口返回值正确性
    ${Resp}    Login_web    /web/user/login
    #校验接口返回状态的正确性
    Check_API_Response    ${Resp}
    log    创建
    ${header}    Create Dictionary    content-type=${Type}
    ${resourceId}    CreateAR    ${URL}    ${header}    ${Resp.cookies}    ${MD5}
    log    ${resourceId}
    #查询AR效果效果
    log    根据md5查询AR效果效果是否显示成功
    : FOR    ${index}    IN RANGE    120
    \    sleep    3s
    \    ${flag}    Set Variable    0
    \    ${mesg}    Get Request    VR    /web/resource/fPoints/${MD5}
    \    Should Be Equal As Strings    ${mesg.status_code}    200
    \    ###从列表中获取字典的值
    \    ${list}    Get Json Value    ${mesg.text}    /status
    \    ${status}    Load Json    ${list}
    \    Run Keyword If    '${status}'=='success'    Exit For Loop
    \    ${flag}    Set Variable    1
    ####
    Run Keyword If    '${flag}'=='1'    fail    10min还没有显示星级，有异常，请排查！！！
    ...    ELSE    log    AR效果效果生成成功！！
    [Teardown]    DeleteResourceId    ${URL}    ${resourceID}
